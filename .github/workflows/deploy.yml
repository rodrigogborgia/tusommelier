name: 3 - Deploy Production

on:
  workflow_run:
    workflows: ["2 - Deploy Staging"]
    branches: [main]
    types: [completed]

permissions:
  contents: read

env:
  DEPLOY_HOST: ${{ secrets.HOST }}
  DEPLOY_USER: ${{ secrets.USERNAME }}
  DEPLOY_KEY: ${{ secrets.KEY }}
  DEPLOY_PORT: '22'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: production
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Validate SSH secrets and connectivity
        shell: bash
        run: |
          set -euo pipefail

          if [ -z "${DEPLOY_HOST}" ]; then
            echo "Missing SSH host secret. Configure HOST."
            exit 1
          fi

          if [ -z "${DEPLOY_USER}" ]; then
            echo "Missing SSH user secret. Configure USERNAME."
            exit 1
          fi

          if [ -z "${DEPLOY_KEY}" ]; then
            echo "Missing SSH private key secret. Configure KEY (Ed25519 private key)."
            exit 1
          fi

          if [ "${DEPLOY_USER}" != "rodrigo" ]; then
            echo "Invalid SSH user in USERNAME secret. Expected: rodrigo"
            exit 1
          fi

          NORMALIZED_KEY="$(printf '%b' "${DEPLOY_KEY}" | tr -d '\r' | sed '1s/^"//' | sed '$s/"$//')"
          KEY_HEADER="$(printf '%s' "${NORMALIZED_KEY}" | sed -n '1p')"

          if printf '%s' "${NORMALIZED_KEY}" | grep -Eq '^ssh-(ed25519|rsa) '; then
            echo "Invalid KEY secret: a PUBLIC key was provided. Configure KEY with the PRIVATE key content (BEGIN ... PRIVATE KEY)."
            exit 1
          fi

          if [ "${KEY_HEADER}" != "-----BEGIN OPENSSH PRIVATE KEY-----" ] && [ "${KEY_HEADER}" != "-----BEGIN PRIVATE KEY-----" ] && [ "${KEY_HEADER}" != "-----BEGIN RSA PRIVATE KEY-----" ] && [ "${KEY_HEADER}" != "-----BEGIN EC PRIVATE KEY-----" ]; then
            echo "Invalid KEY secret format. Expected a valid private key block header."
            echo "Current first line: ${KEY_HEADER}"
            exit 1
          fi

          python - <<'PY'
          import os
          import socket

          host = os.environ["DEPLOY_HOST"]
          port = int(os.environ.get("DEPLOY_PORT", "22"))

          try:
              with socket.create_connection((host, port), timeout=8):
                  print(f"SSH TCP connectivity OK: {host}:{port}")
          except Exception as exc:
              raise SystemExit(f"Cannot reach SSH endpoint {host}:{port} from GitHub runner: {exc}")
          PY

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEPLOY_HOST }}
          username: ${{ env.DEPLOY_USER }}
          key: ${{ env.DEPLOY_KEY }}
          port: ${{ env.DEPLOY_PORT }}
          timeout: 120s
          command_timeout: 70m
          script_stop: true
          script: |
            set -euo pipefail

            APP_DIR="/home/${{ env.DEPLOY_USER }}/tusommelier"
            VENV_DIR="${APP_DIR}/.venv"
            VENV_PY="${VENV_DIR}/bin/python3"
            VENV_PIP="${VENV_DIR}/bin/pip"

            cd "${APP_DIR}"

            git fetch origin main
            git reset --hard origin/main

            echo "[deploy] Verificando runtime Python"
            if ! command -v python3 >/dev/null 2>&1; then
              echo "python3 no está disponible en el servidor"
              exit 1
            fi

            if [ ! -x "${VENV_PY}" ] || [ ! -x "${VENV_PIP}" ]; then
              echo "[deploy] Reparando/creando virtualenv en ${VENV_DIR}"
              sudo rm -rf "${VENV_DIR}" || true
              python3 -m venv --copies "${VENV_DIR}" || {
                echo "[deploy] creación de venv falló; instalando python3-venv/python3-pip y reintentando"
                sudo apt-get update -y
                sudo apt-get install -y python3-venv python3-pip
                python3 -m venv --copies "${VENV_DIR}"
              }
              sudo chown -R "$(id -un)":"$(id -gn)" "${VENV_DIR}" || true
            fi

            if [ ! -x "${VENV_PY}" ] && [ -x "${VENV_DIR}/bin/python" ]; then
              ln -sf "${VENV_DIR}/bin/python" "${VENV_PY}"
            fi

            if [ ! -x "${VENV_PIP}" ] && [ -x "${VENV_DIR}/bin/pip3" ]; then
              ln -sf "${VENV_DIR}/bin/pip3" "${VENV_PIP}"
            fi

            if [ ! -x "${VENV_PIP}" ] && [ -x "${VENV_PY}" ]; then
              "${VENV_PY}" -m ensurepip --upgrade || true
            fi

            if [ ! -x "${VENV_PIP}" ] && [ -x "${VENV_DIR}/bin/pip3" ]; then
              ln -sf "${VENV_DIR}/bin/pip3" "${VENV_PIP}"
            fi

            if [ ! -x "${VENV_PY}" ] || [ ! -x "${VENV_PIP}" ]; then
              echo "Virtualenv binaries not found in ${VENV_DIR}/bin"
              exit 1
            fi

            if ! command -v npm >/dev/null 2>&1; then
              echo "npm is not installed on server. Install Node.js/npm once on host, then rerun deploy."
              exit 1
            fi

            "${VENV_PY}" -m pip install --upgrade pip
            "${VENV_PIP}" install -r "${APP_DIR}/backend/requirements.txt"

            cd my-tavus-app
            npm ci --legacy-peer-deps
            npm run build
            cd ..

            sudo mkdir -p /var/www/frontend
            sudo find /var/www/frontend -mindepth 1 -maxdepth 1 -exec rm -rf {} +
            sudo cp -r my-tavus-app/dist/. /var/www/frontend/

            sed "s/__SERVER_USER__/${{ env.DEPLOY_USER }}/g" deploy/systemd/tusommelier-backend.service > /tmp/tusommelier-backend.service
            sudo mv /tmp/tusommelier-backend.service /etc/systemd/system/tusommelier-backend.service

            SSL_CERT_DIR="/etc/nginx/certs/tusommeliervirtual.com"
            if [ ! -f "${SSL_CERT_DIR}/fullchain.pem" ] || [ ! -f "${SSL_CERT_DIR}/key.pem" ]; then
              echo "SSL certificate files not found in ${SSL_CERT_DIR}"
              echo "Expected files: fullchain.pem and key.pem"
              exit 1
            fi

            sudo cp nginx.conf /etc/nginx/sites-available/tusommelier
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo ln -sfn /etc/nginx/sites-available/tusommelier /etc/nginx/sites-enabled/tusommelier
            sudo nginx -t
            sudo systemctl reload nginx

            sudo systemctl daemon-reload
            sudo systemctl enable tusommelier-backend
            sudo systemctl reset-failed tusommelier-backend || true

            echo "Liberando puerto 8000 antes de iniciar backend"
            sudo fuser -k 8000/tcp || true
            sudo lsof -t -i:8000 | xargs -r sudo kill -9 || true

            sudo systemctl restart tusommelier-backend
            sudo systemctl --no-pager --full status tusommelier-backend | head -n 20

            BACKEND_READY=0
            for _ in $(seq 1 20); do
              if sudo systemctl is-active --quiet tusommelier-backend && curl -fsS --connect-timeout 3 --max-time 8 http://127.0.0.1:8000/health >/dev/null 2>&1; then
                BACKEND_READY=1
                break
              fi
              sleep 2
            done

            if [ "${BACKEND_READY}" != "1" ]; then
              echo "Backend health check failed on 127.0.0.1:8000"
              sudo systemctl --no-pager --full status tusommelier-backend | head -n 40 || true
              sudo journalctl -u tusommelier-backend -n 120 --no-pager
              exit 1
            fi

            API_OK=0
            for _ in $(seq 1 15); do
              API_STATUS=$(curl -sS --connect-timeout 3 --max-time 10 -o /tmp/tusommelier_api_health.txt -w "%{http_code}" -H "Host: tusommeliervirtual.com" http://127.0.0.1/api/health || true)
              if [ "${API_STATUS}" = "200" ]; then
                API_OK=1
                break
              fi

              if [ "${API_STATUS}" = "301" ] || [ "${API_STATUS}" = "302" ] || [ "${API_STATUS}" = "307" ] || [ "${API_STATUS}" = "308" ]; then
                HTTPS_STATUS=$(curl -sS --connect-timeout 3 --max-time 10 --resolve tusommeliervirtual.com:443:127.0.0.1 -o /tmp/tusommelier_api_health.txt -w "%{http_code}" https://tusommeliervirtual.com/api/health || true)
                if [ "${HTTPS_STATUS}" = "200" ]; then
                  API_OK=1
                  API_STATUS="${HTTPS_STATUS}"
                  break
                fi
              fi

              sleep 2
            done

            if [ "${API_OK}" != "1" ]; then
              echo "Nginx /api health check failed with status ${API_STATUS}"
              cat /tmp/tusommelier_api_health.txt || true
              sudo tail -n 100 /var/log/nginx/tusommelier_error.log || true
              exit 1
            fi
