name: Dependabot Auto-Merge

on:
  pull_request_target:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_run:
    workflows: [1- CI, E2E Tests]
    types: [completed]

permissions:
  actions: read
  pull-requests: write
  contents: write

jobs:
  evaluate:
    name: Evaluate Dependabot PR and checks
    runs-on: ubuntu-latest
    outputs:
      pr-number: ${{ steps.eval.outputs.pr-number }}
      automerge: ${{ steps.eval.outputs.automerge }}
      checks-state: ${{ steps.eval.outputs.checks-state }}
    steps:
      - name: Resolve PR and validate checks
        id: eval
        run: |
          PR_NUMBER=""

          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            PR_NUMBER=$(jq -r '.workflow_run.pull_requests[0].number // ""' "$GITHUB_EVENT_PATH")
          fi

          if [ -z "$PR_NUMBER" ]; then
            echo "pr-number=" >> $GITHUB_OUTPUT
            echo "automerge=false" >> $GITHUB_OUTPUT
            echo "checks-state=missing-pr" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_STATE=$(gh pr view "$PR_NUMBER" --json state,isDraft,author,headRefOid -q '{state: .state, isDraft: .isDraft, author: .author.login, sha: .headRefOid}')
          AUTHOR=$(echo "$PR_STATE" | jq -r '.author')
          STATE=$(echo "$PR_STATE" | jq -r '.state')
          IS_DRAFT=$(echo "$PR_STATE" | jq -r '.isDraft')
          SHA=$(echo "$PR_STATE" | jq -r '.sha')

          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT

          if [ "$AUTHOR" != "dependabot[bot]" ] || [ "$STATE" != "OPEN" ] || [ "$IS_DRAFT" = "true" ]; then
            echo "automerge=false" >> $GITHUB_OUTPUT
            echo "checks-state=not-eligible" >> $GITHUB_OUTPUT
            exit 0
          fi

          RUNS=$(gh api "repos/${{ github.repository }}/actions/runs?event=pull_request&head_sha=$SHA&per_page=100")

          CI_STATUS=$(echo "$RUNS" | jq -r '[.workflow_runs[] | select(.name == "1- CI") | .status][0] // "missing"')
          CI_CONCLUSION=$(echo "$RUNS" | jq -r '[.workflow_runs[] | select(.name == "1- CI") | .conclusion][0] // "missing"')
          E2E_STATUS=$(echo "$RUNS" | jq -r '[.workflow_runs[] | select(.name == "E2E Tests") | .status][0] // "missing"')
          E2E_CONCLUSION=$(echo "$RUNS" | jq -r '[.workflow_runs[] | select(.name == "E2E Tests") | .conclusion][0] // "missing"')

          if [ "$CI_STATUS" = "completed" ] && [ "$CI_CONCLUSION" = "success" ] && [ "$E2E_STATUS" = "completed" ] && [ "$E2E_CONCLUSION" = "success" ]; then
            echo "automerge=true" >> $GITHUB_OUTPUT
            echo "checks-state=success" >> $GITHUB_OUTPUT
          elif [ "$CI_STATUS" = "missing" ] || [ "$E2E_STATUS" = "missing" ] || [ "$CI_STATUS" != "completed" ] || [ "$E2E_STATUS" != "completed" ]; then
            echo "automerge=false" >> $GITHUB_OUTPUT
            echo "checks-state=pending" >> $GITHUB_OUTPUT
          else
            echo "automerge=false" >> $GITHUB_OUTPUT
            echo "checks-state=failed" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

  auto-merge:
    name: Auto-merge Dependabot PR
    runs-on: ubuntu-latest
    needs: evaluate
    if: needs.evaluate.outputs.automerge == 'true'
    steps:
      - name: Merge PR with squash and delete branch
        run: |
          PR_NUMBER="${{ needs.evaluate.outputs.pr-number }}"

          gh pr merge "$PR_NUMBER" --squash --delete-branch --auto || \
          gh pr merge "$PR_NUMBER" --squash --delete-branch
        env:
          GH_TOKEN: ${{ github.token }}

  notify-failure:
    name: Notify when checks fail
    runs-on: ubuntu-latest
    needs: evaluate
    if: needs.evaluate.outputs.checks-state == 'failed'
    steps:
      - name: Comment on PR about CI failure
        run: |
          PR_NUMBER="${{ needs.evaluate.outputs.pr-number }}"
          gh pr comment "$PR_NUMBER" -b "⚠️ CI/E2E checks did not pass. Please review workflow failures before merging."
        env:
          GH_TOKEN: ${{ github.token }}
