version: '3.8'

# ════════════════════════════════════════════════════════════════════════════
# Arquitectura: Frontend + Backend + Nginx
# Dominio: https://tusommeliervirtual.com
# Routes:
#   - / → Frontend (React)
#   - /api/ → Backend (Python)
# SSL: Let's Encrypt (manual o via certbot)
# ════════════════════════════════════════════════════════════════════════════

services:
  # ═════════════════════════════════════════════════════════════════════════
  # BACKEND - API Python (Tavus + LLM)
  # ═════════════════════════════════════════════════════════════════════════
  backend:
    build:
      context: ./backend
      dockerfile: dockerfile
    container_name: tusommelier-backend
    restart: always
    
    # Variables de entorno
    env_file:
      - ./config/secrets.env
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
    
    # Puertos (solo internos, no exponemos al mundo exterior)
    expose:
      - "8000"
    
    # Volúmenes (opcional, para logs persistentes)
    volumes:
      - ./backend:/app
      - backend-logs:/var/log/backend
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Network
    networks:
      - sommelier-network
    
    # Limites de recursos (opcional)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # ═════════════════════════════════════════════════════════════════════════
  # FRONTEND - React + Vite
  # ═════════════════════════════════════════════════════════════════════════
  frontend:
    build:
      context: ./my-tavus-app
      dockerfile: Dockerfile
      args:
        - NODE_ENV=production
    container_name: tusommelier-frontend
    restart: always
    
    # Puertos (solo internos)
    expose:
      - "5173"
    
    # Variables de entorno
    environment:
      - NODE_ENV=production
      - VITE_TAVUS_API_KEY=${VITE_TAVUS_API_KEY}
      - VITE_REPLICA_ID=${VITE_REPLICA_ID}
      - VITE_PERSONA_ID=${VITE_PERSONA_ID}
      # NO necesita VITE_BACKEND_URL porque usa /api (relativo)
    
    # Volúmenes (opcional)
    volumes:
      - frontend-logs:/var/log/frontend
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5173"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Network
    networks:
      - sommelier-network
    
    # Dependencias
    depends_on:
      - backend

  # ═════════════════════════════════════════════════════════════════════════
  # NGINX - Reverse Proxy + SSL + Static Files
  # ═════════════════════════════════════════════════════════════════════════
  nginx:
    image: nginx:alpine
    container_name: tusommelier-nginx
    restart: always
    
    # Puertos (exponemos HTTP y HTTPS)
    ports:
      - "80:80"
      - "443:443"
    
    # Volúmenes
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./var/www/frontend:/var/www/frontend:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - nginx-cache:/var/cache/nginx
      - nginx-logs:/var/log/nginx
    
    # Logging
    environment:
      - TZ=America/Argentina/Buenos_Aires
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s
    
    # Network
    networks:
      - sommelier-network
    
    # Dependencias
    depends_on:
      - frontend
      - backend
    
    # Limites de recursos
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # ═════════════════════════════════════════════════════════════════════════
  # (OPCIONAL) CERTBOT - Auto-renovación de certificados SSL
  # ═════════════════════════════════════════════════════════════════════════
  # certbot:
  #   image: certbot/certbot
  #   container_name: tusommelier-certbot
  #   restart: always
  #   volumes:
  #     - /etc/letsencrypt:/etc/letsencrypt
  #     - ./var/www/certbot:/var/www/certbot
  #   # Ejecutar renovación cada 12 horas
  #   command: renew --webroot -w /var/www/certbot --quiet
  #   networks:
  #     - sommelier-network
  #   depends_on:
  #     - nginx

# ════════════════════════════════════════════════════════════════════════════
# VOLÚMENES (Persistencia de datos)
# ════════════════════════════════════════════════════════════════════════════
volumes:
  backend-logs:
    driver: local
  frontend-logs:
    driver: local
  nginx-cache:
    driver: local
  nginx-logs:
    driver: local

# ════════════════════════════════════════════════════════════════════════════
# NETWORKS (Aislamiento)
# ════════════════════════════════════════════════════════════════════════════
networks:
  sommelier-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/16

# ════════════════════════════════════════════════════════════════════════════
# COMANDOS ÚTILES
# ════════════════════════════════════════════════════════════════════════════
# 
# # Iniciar servicios
# docker-compose up -d
# 
# # Ver logs en vivo
# docker-compose logs -f                    # Todos
# docker-compose logs -f backend            # Solo backend
# docker-compose logs -f frontend           # Solo frontend
# docker-compose logs -f nginx              # Solo nginx
# 
# # Detener servicios
# docker-compose down
# 
# # Reiniciar servicio específico
# docker-compose restart backend
# docker-compose restart frontend
# 
# # Ejecutar comando en contenedor
# docker-compose exec backend bash
# docker-compose exec frontend sh
# docker-compose exec nginx sh
# 
# # Ver estado de servicios
# docker-compose ps
# 
# # Eliminar todo (incluyendo volúmenes)
# docker-compose down -v
# 
# # Rebuild de imágenes
# docker-compose build --no-cache
# 
# ════════════════════════════════════════════════════════════════════════════
